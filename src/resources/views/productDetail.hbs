<div class="container-fluid product-detail">
    <div class="row">
        <!-- Cột thông tin mô tả -->
        <div class="product-detail-info col-lg-4 col-12 order-lg-1 order-3">
            <h2 class="product-detail-info-title">Thông tin</h2>
            <p class="product-detail-info-des">{{product.des}}</p>
        </div>

        <!-- Cột hình ảnh sản phẩm -->
        <div class="product-detail-img-block col-lg-4 col-12 order-lg-2  order-1">
            <div id="carouselProductImages" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    {{#each product.images}}
                        <div class="carousel-item {{ifIndexZero @index}}">
                            <img class="product-detail-img" src="{{this}}" alt="Slide {{@index}}">
                        </div>
                    {{/each}}
                </div>
                <a class="carousel-control-prev" href="#carouselProductImages" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselProductImages" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>

        <!-- Cột thông tin mua hàng -->
        <div class="product-detail-view-side col-lg-4 col-12 order-lg-3 order-2">
            <h1 class="product-detail-view-side-title">{{product.name}}</h1>

            <p class="product-detail-view-side-price">{{formatPrice product.price}}</p>

            <div class="product-detail-btn-container">
                <!-- Nút mua ngay -->
                <form action="/payment/buy-now" method="POST">
                    <input type="hidden" name="productId" value="{{product.id}}">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn btn-dark btn-buy-item">Mua ngay</button>
                </form>
                
                <!-- Thêm vào giỏ -->
                <form action="/carts/add/{{product.id}}" method="POST">
                    <button type="submit" class="btn btn-dark btn-add-card">Thêm vào giỏ</button>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ================= ĐÁNH GIÁ SẢN PHẨM ================= -->
        <div class="product-reviews mt-5 col-sm-12 col-md-8 offset-md-2">
            <h3 class="mb-3">Đánh giá sản phẩm</h3>

            <!-- Tổng quan -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="statistic">
                    <div class="stat">
                        <span class="me-3 fw-semibold">TỔNG SỐ ĐÁNH GIÁ</span>
                        <span class="fs-4 fw-bold text-primary me-4">{{totalReviews}}</span>
                    </div>
                </div>
                
                <div class="stat">
                    <span class="me-3 fw-semibold">ĐÁNH GIÁ TRUNG BÌNH</span>
                    <span class="fs-4 fw-bold text-warning">{{averageRating}}</span>
                </div>
                
            </div>

            <!-- Danh sách đánh giá -->
            <div class="review-list mt-3">
                {{#if reviews.length}}
                    {{#each reviews}}
                    <div class="review-item border rounded p-3 mb-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{this.username}}</strong>
                        </div>

                        <div>
                            <small class="text-muted">{{formatBD this.createdAt}}</small>

                            {{!-- Nếu đã đăng nhập --}}
                            {{#if @root.user}}
                            {{!-- Nếu là admin hoặc chính người viết đánh giá --}}
                            {{#if (or (eq @root.user.role "admin") (eq @root.user.id this.user_id))}}
                                <form action="/products/reviews/{{this.id}}/delete" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger ms-2"
                                    onclick="return confirm('Bạn có chắc muốn xóa đánh giá này không?')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                                </form>
                            {{/if}}
                            {{/if}}
                        </div>
                        </div>

                        <div class="text-warning">
                        {{#each (range 1 this.rating)}}★{{/each}}
                        {{#each (range 1 (sub 5 this.rating))}}<span class="text-secondary">★</span>{{/each}}
                        </div>

                        <p class="mt-2 mb-0">{{this.comment}}</p>
                    </div>
                    {{/each}}

                {{else}}
                    <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                {{/if}}
            </div>

            <!-- Form gửi đánh giá -->
            {{#if user}}
                {{#if hasUserPurchased}}
                    <div class="mt-4">
                        {{#if userReview}}
                        <h5>Sửa đánh giá của bạn</h5>
                        {{else}}
                        <h5>Gửi đánh giá của bạn</h5>
                        {{/if}}

                        <form action="/products/{{product.id}}/reviews" method="POST" class="p-3 border rounded">
                            <div class="form-group mb-3">
                                <label>Chọn số sao:</label>
                                <div class="rating">
                                    {{#each (rangeStar 5 1 -1)}}
                                    <input 
                                        type="radio" 
                                        id="star{{this}}" 
                                        name="rating" 
                                        value="{{this}}" 
                                        {{#if (eq ../userReview.rating this)}}checked{{/if}}
                                    />
                                    <label for="star{{this}}" title="{{this}} sao">★</label>
                                    {{/each}}
                                </div>
                            </div>
            
                            <div class="form-group mb-3">
                                <label for="comment">Nhận xét:</label>
                                <textarea id="comment" name="comment" rows="3" class="form-control" placeholder="Nhập nhận xét của bạn..." required>{{userReview.comment}}</textarea>
                            </div>

                            <button type="submit" class="btn btn-dark">
                                {{#if userReview}}Cập nhật đánh giá{{else}}Gửi đánh giá{{/if}}
                            </button>
                        </form>
                    </div>
                {{else}}
                    <p class="text-muted mt-3"><i>Bạn cần mua sản phẩm này trước khi có thể đánh giá.</i></p>
                {{/if}}
            {{else}}
                <p class="mt-3">Vui lòng <a href="/accounts/login">đăng nhập</a> để gửi đánh giá.</p>
            {{/if}}

        </div>
    </div>
</div>

<style>
.product-reviews {
  background-color: #ffffff;
  color: #000000;
  padding: 20px;
  border-radius: 10px;
}

/* Tiêu đề */
.product-reviews h3 {
  border-bottom: 2px solid #333;
  padding-bottom: 10px;
}

/* Khu vực thống kê */
.statistic {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px 24px;
  margin-block: 24px;
}

.stat {
  display: flex;
  align-items: baseline;
  gap: 24px;
}

/* Danh sách đánh giá */
.review-list {
  max-height: 400px;           /* Giới hạn chiều cao khung đánh giá */
  overflow-y: auto;            /* Thêm thanh cuộn dọc */
  padding-right: 10px;         /* Tránh chữ đè lên thanh cuộn */
  scrollbar-width: thin;       /* Thanh cuộn mảnh (Firefox) */
}

.review-list::-webkit-scrollbar {
  width: 6px;
}

.review-list::-webkit-scrollbar-thumb {
  background: #aaa;
  border-radius: 10px;
}

/* Từng đánh giá */
.review-item {
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #fafafa;
  transition: all 0.2s ease;
}

.review-item:hover {
  background-color: #f1f1f1;
}

/* Màu sao */
.text-warning {
  color: #f4c542 !important;
}

/* ===== FORM SAO VÀNG ===== */
.rating {
  direction: rtl;
  display: inline-flex;
  gap: 4px;
  justify-content: flex-start;
}

.rating input[type="radio"] {
  display: none;
}

.rating label {
  font-size: 28px;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s;
}

.rating label:hover,
.rating label:hover ~ label {
  color: #f4c542;
}

.rating input:checked ~ label {
  color: #f4c542;
}


</style>
